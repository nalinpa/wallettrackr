{% extends "base.html" %}

{% block title %}Monitor - Crypto Alpha Analysis{% endblock %}

{% block head %}
<style>
    .crypto-card {
        background: linear-gradient(145deg, #2c3e50, #34495e);
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: 15px;
        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
    }
    
    .status-indicator {
        width: 12px;
        height: 12px;
        border-radius: 50%;
        background: #6c757d;
        margin-right: 10px;
        display: inline-block;
    }
    
    .status-indicator.active {
        background: #28a745;
        animation: pulse 2s infinite;
    }
    
    .console-output {
        background: #0a0a0a;
        border: 1px solid #333;
        border-radius: 8px;
        padding: 20px;
        font-family: 'Courier New', monospace;
        font-size: 0.9rem;
        max-height: 500px;
        overflow-y: auto;
        white-space: pre-wrap;
        word-wrap: break-word;
    }
    
    .console-line {
        margin-bottom: 5px;
        padding: 2px 0;
    }
    
    .console-line.success { color: #28a745; }
    .console-line.error { color: #dc3545; }
    .console-line.info { color: #007bff; }
    .console-line.warning { color: #ffc107; }
    
    .alert-item {
        background: rgba(0, 0, 0, 0.3);
        padding: 15px;
        margin: 10px 0;
        border-radius: 8px;
        border-left: 4px solid #28a745;
    }
    
    .alert-item.surge {
        border-left-color: #ffc107;
    }
    
    .alert-token {
        font-size: 1.2rem;
        font-weight: bold;
        color: #ffc107;
        margin-bottom: 8px;
    }
    
    .alert-contract {
        font-family: 'Courier New', monospace;
        font-size: 0.85rem;
        background: rgba(0, 0, 0, 0.5);
        padding: 8px;
        border-radius: 4px;
        margin-top: 10px;
        word-break: break-all;
    }
</style>
{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-12">
        <div class="crypto-card p-4">
            <h3 class="mb-3">Monitor Control</h3>
            
            <div class="d-flex align-items-center mb-3">
                <span class="status-indicator" id="status-indicator"></span>
                <span id="status-text" class="me-3">Loading...</span>
                <span id="monitor-status" class="badge bg-secondary">Inactive</span>
            </div>

            <div class="d-flex flex-wrap gap-2 mb-3">
                <button class="btn btn-success" id="start-btn" onclick="startMonitor()">
                    <i class="fas fa-play me-2"></i>Start Monitor
                </button>
                <button class="btn btn-danger" id="stop-btn" onclick="stopMonitor()" style="display: none;">
                    <i class="fas fa-stop me-2"></i>Stop Monitor
                </button>
                <button class="btn btn-warning" onclick="checkNow()">
                    <i class="fas fa-search me-2"></i>Check Now
                </button>
                <button class="btn btn-info" onclick="testConnection()">
                    <i class="fas fa-vial me-2"></i>Test Connection
                </button>
                <button class="btn btn-secondary" onclick="clearConsole()">
                    <i class="fas fa-trash me-2"></i>Clear Console
                </button>
            </div>

            <div class="row g-3">
                <div class="col-md-4">
                    <div class="crypto-card p-3 text-center">
                        <h6 class="text-muted text-uppercase mb-1">Last Check</h6>
                        <div class="h6 text-info" id="last-check">Never</div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="crypto-card p-3 text-center">
                        <h6 class="text-muted text-uppercase mb-1">Next Check</h6>
                        <div class="h6 text-warning" id="next-check">-</div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="crypto-card p-3 text-center">
                        <h6 class="text-muted text-uppercase mb-1">Status</h6>
                        <div class="h6 text-success" id="monitor-status-display">Inactive</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Console Output -->
<div class="row mb-4">
    <div class="col-12">
        <div class="crypto-card p-4">
            <h3 class="mb-3">Console Output</h3>
            <div class="console-output" id="console-output">
                <div class="console-line info">Monitor console ready. Click "Check Now" to run a check.</div>
            </div>
        </div>
    </div>
</div>

<!-- Configuration -->
<div class="row mb-4">
    <div class="col-12">
        <div class="crypto-card p-4">
            <h3 class="mb-3">Configuration</h3>
            
            <div class="row g-3">
                <div class="col-md-6 col-lg-4">
                    <label class="form-label">Check Interval (minutes)</label>
                    <select id="interval-select" class="form-select" onchange="updateConfig()">
                        <option value="5">5 minutes</option>
                        <option value="15">15 minutes</option>
                        <option value="30">30 minutes</option>
                        <option value="60" selected>1 hour</option>
                        <option value="120">2 hours</option>
                        <option value="240">4 hours</option>
                    </select>
                </div>
                
                <div class="col-md-6 col-lg-4">
                    <label class="form-label">Networks</label>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="network-eth" onchange="updateConfig()">
                        <label class="form-check-label" for="network-eth">Ethereum</label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="network-base" checked onchange="updateConfig()">
                        <label class="form-check-label" for="network-base">Base</label>
                    </div>
                </div>
                
                <div class="col-md-6 col-lg-4">
                    <label class="form-label">Wallets to Check</label>
                    <input type="number" id="num-wallets" value="50" min="5" max="174" class="form-control" onchange="updateConfig()">
                </div>
                
                <div class="col-md-6 col-lg-4">
                    <label class="form-label">Min Wallets for Alert</label>
                    <input type="number" id="min-wallets" value="2" min="1" max="20" class="form-control" onchange="updateThresholds()">
                </div>
                
                <div class="col-md-6 col-lg-4">
                    <label class="form-label">Min ETH Spent</label>
                    <input type="number" id="min-eth" value="0.5" step="0.1" min="0.1" class="form-control" onchange="updateThresholds()">
                </div>
                
                <div class="col-md-6 col-lg-4">
                    <label class="form-label">Min Alpha Score</label>
                    <input type="number" id="min-score" value="30" min="10" max="100" class="form-control" onchange="updateThresholds()">
                </div>
            </div>
            
            <div class="form-check mt-3">
                <input class="form-check-input" type="checkbox" id="use-interval-timeframe" checked onchange="updateConfig()">
                <label class="form-check-label" for="use-interval-timeframe">
                    Only check new activity since last check (recommended)
                </label>
            </div>
        </div>
    </div>
</div>

<!-- Recent Alerts -->
<div class="row">
    <div class="col-12">
        <div class="crypto-card p-4">
            <h3 class="mb-3">Recent Alerts</h3>
            <div id="alerts-container">
                <p class="text-muted">No alerts yet.</p>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let isMonitorRunning = false;

// Add console logging for debugging
function log(message, type = 'info') {
    console.log(`[Monitor] ${message}`);
    const output = document.getElementById('console-output');
    const line = document.createElement('div');
    line.className = `console-line ${type}`;
    const timestamp = new Date().toLocaleTimeString();
    line.textContent = `[${timestamp}] ${message}`;
    output.appendChild(line);
    output.scrollTop = output.scrollHeight;
}

function clearConsole() {
    document.getElementById('console-output').innerHTML = '<div class="console-line info">Console cleared.</div>';
}

// Load monitor status on page load
window.addEventListener('DOMContentLoaded', function() {
    log('Page loaded, checking monitor status...');
    loadStatus();
});

function loadStatus() {
    log('Loading monitor status...');
    
    fetch('/api/monitor/status')
        .then(response => {
            log(`Status response: ${response.status}`);
            return response.json();
        })
        .then(data => {
            log(`Monitor running: ${data.is_running}`, 'success');
            updateUI(data);
        })
        .catch(error => {
            log(`Error loading status: ${error}`, 'error');
            console.error('Full error:', error);
        });
}

function updateUI(status) {
    const indicator = document.getElementById('status-indicator');
    const statusText = document.getElementById('status-text');
    const startBtn = document.getElementById('start-btn');
    const stopBtn = document.getElementById('stop-btn');
    const monitorStatus = document.getElementById('monitor-status');
    const monitorStatusDisplay = document.getElementById('monitor-status-display');
    
    isMonitorRunning = status.is_running;
    
    if (isMonitorRunning) {
        indicator.classList.add('active');
        statusText.textContent = 'Monitor Active';
        monitorStatus.className = 'badge bg-success';
        monitorStatus.textContent = 'Active';
        monitorStatusDisplay.textContent = 'Active';
        monitorStatusDisplay.className = 'h6 text-success';
        startBtn.style.display = 'none';
        stopBtn.style.display = 'inline-block';
    } else {
        indicator.classList.remove('active');
        statusText.textContent = 'Monitor Inactive';
        monitorStatus.className = 'badge bg-secondary';
        monitorStatus.textContent = 'Inactive';
        monitorStatusDisplay.textContent = 'Inactive';
        monitorStatusDisplay.className = 'h6 text-secondary';
        startBtn.style.display = 'inline-block';
        stopBtn.style.display = 'none';
    }
    
    if (status.last_check) {
        document.getElementById('last-check').textContent = new Date(status.last_check).toLocaleTimeString();
    }
    
    if (status.next_check && isMonitorRunning) {
        document.getElementById('next-check').textContent = new Date(status.next_check).toLocaleTimeString();
    } else {
        document.getElementById('next-check').textContent = '-';
    }
    
    // Update config fields
    if (status.config) {
        document.getElementById('interval-select').value = status.config.check_interval_minutes || 60;
        document.getElementById('num-wallets').value = status.config.num_wallets || 50;
        document.getElementById('use-interval-timeframe').checked = status.config.use_interval_for_timeframe !== false;
        
        // Update network checkboxes
        document.getElementById('network-eth').checked = status.config.networks && status.config.networks.includes('eth');
        document.getElementById('network-base').checked = status.config.networks && status.config.networks.includes('base');
    }
    
    // Update thresholds
    if (status.alert_thresholds) {
        document.getElementById('min-wallets').value = status.alert_thresholds.min_wallets || 2;
        document.getElementById('min-eth').value = status.alert_thresholds.min_eth_spent || 0.5;
        document.getElementById('min-score').value = status.alert_thresholds.min_alpha_score || 30;
    }
    
    // Load alerts
    loadAlerts();
}

function startMonitor() {
    log('Starting monitor...', 'info');
    
    fetch('/api/monitor/start', { 
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        }
    })
    .then(response => {
        log(`Start response: ${response.status}`);
        return response.json();
    })
    .then(data => {
        log(`Monitor started: ${data.message}`, data.status === 'success' ? 'success' : 'error');
        loadStatus();
    })
    .catch(error => {
        log(`Error starting monitor: ${error}`, 'error');
        console.error('Full error:', error);
    });
}

function stopMonitor() {
    log('Stopping monitor...', 'info');
    
    fetch('/api/monitor/stop', { 
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        }
    })
    .then(response => {
        log(`Stop response: ${response.status}`);
        return response.json();
    })
    .then(data => {
        log(`Monitor stopped: ${data.message}`, data.status === 'success' ? 'success' : 'error');
        loadStatus();
    })
    .catch(error => {
        log(`Error stopping monitor: ${error}`, 'error');
        console.error('Full error:', error);
    });
}

function checkNow() {
    log('🔍 Running immediate check...', 'warning');
    log('Check server console for detailed output', 'info');
    
    fetch('/api/monitor/check-now', { 
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        }
    })
    .then(response => {
        log(`Check response: ${response.status}`);
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        return response.json();
    })
    .then(data => {
        log(`Check initiated: ${data.message}`, data.status === 'success' ? 'success' : 'error');
        
        // Load alerts after a delay
        setTimeout(() => {
            log('Loading alerts...');
            loadAlerts();
        }, 5000);
    })
    .catch(error => {
        log(`Error running check: ${error}`, 'error');
        console.error('Full error:', error);
    });
}

function testConnection() {
    log('Testing monitor connection...', 'info');
    
    fetch('/api/monitor/test')
        .then(response => {
            log(`Test response: ${response.status}`);
            return response.json();
        })
        .then(data => {
            log(`Test result: ${JSON.stringify(data)}`, 'success');
        })
        .catch(error => {
            log(`Test failed: ${error}`, 'error');
            console.error('Full error:', error);
        });
}

function updateConfig() {
    const networks = [];
    if (document.getElementById('network-eth').checked) networks.push('eth');
    if (document.getElementById('network-base').checked) networks.push('base');
    
    const config = {
        check_interval_minutes: parseInt(document.getElementById('interval-select').value),
        networks: networks,
        num_wallets: parseInt(document.getElementById('num-wallets').value),
        use_interval_for_timeframe: document.getElementById('use-interval-timeframe').checked
    };
    
    log(`Updating config: ${JSON.stringify(config)}`, 'info');
    
    fetch('/api/monitor/config', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(config)
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success') {
            log('Configuration updated successfully', 'success');
            loadStatus();
        } else {
            log(`Config update failed: ${data.message}`, 'error');
        }
    })
    .catch(error => {
        log(`Error updating config: ${error}`, 'error');
    });
}

function updateThresholds() {
    const thresholds = {
        min_wallets: parseInt(document.getElementById('min-wallets').value),
        min_eth_spent: parseFloat(document.getElementById('min-eth').value),
        min_alpha_score: parseFloat(document.getElementById('min-score').value)
    };
    
    log(`Updating thresholds: ${JSON.stringify(thresholds)}`, 'info');
    
    fetch('/api/monitor/thresholds', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(thresholds)
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success') {
            log('Thresholds updated successfully', 'success');
        } else {
            log(`Threshold update failed: ${data.message}`, 'error');
        }
    })
    .catch(error => {
        log(`Error updating thresholds: ${error}`, 'error');
    });
}

function loadAlerts() {
    fetch('/api/monitor/alerts?limit=20')
        .then(response => response.json())
        .then(alerts => {
            const container = document.getElementById('alerts-container');
            
            if (alerts.length === 0) {
                container.innerHTML = '<p class="text-muted">No alerts yet.</p>';
                log('No alerts found');
            } else {
                log(`Found ${alerts.length} alerts`, 'success');
                
                let html = '';
                alerts.reverse().forEach(alert => {  // Show newest first
                    const alertClass = alert.alert_type === 'surge' ? 'surge' : '';
                    const alertEmoji = alert.alert_type === 'new' ? '🆕' : '📈';
                    const networkBadge = alert.network ? `<span class="badge bg-info ms-2">${alert.network.toUpperCase()}</span>` : '';
                    
                    html += `
                        <div class="alert-item ${alertClass}">
                            <div class="alert-token">
                                ${alertEmoji} ${alert.token} ${networkBadge}
                            </div>
                            <div class="row g-2 mb-2">
                                <div class="col-md-3">
                                    <small class="text-muted">ETH Spent:</small>
                                    <div class="fw-bold text-success">${alert.total_eth_spent.toFixed(3)} ETH</div>
                                </div>
                                <div class="col-md-3">
                                    <small class="text-muted">Wallets:</small>
                                    <div class="fw-bold text-info">${alert.wallet_count}</div>
                                </div>
                                <div class="col-md-3">
                                    <small class="text-muted">Score:</small>
                                    <div class="fw-bold text-warning">${alert.alpha_score.toFixed(0)}</div>
                                </div>
                                <div class="col-md-3">
                                    <small class="text-muted">Platforms:</small>
                                    <div class="small">${alert.platforms.slice(0, 2).join(', ')}</div>
                                </div>
                            </div>
                            <div class="alert-contract">
                                📋 ${alert.contract_address}
                            </div>
                            <div class="mt-2">
                                <small class="text-muted">
                                    🕐 ${new Date(alert.first_seen).toLocaleString()}
                                </small>
                            </div>
                        </div>
                    `;
                });
                
                container.innerHTML = html;
            }
        })
        .catch(error => {
            log(`Error loading alerts: ${error}`, 'error');
        });
}

// Auto-refresh status every 30 seconds
setInterval(() => {
    if (isMonitorRunning) {
        loadStatus();
    }
}, 30000);
</script>
{% endblock %}